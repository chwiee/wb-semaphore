trigger: none

variables: 
  - group: SEMAPHORE-UI

pool:
  name: wblocal 

stages:

- stage: changes
  displayName: 'Get changes'
  jobs:
  - job: changeJob
    displayName: 'Get changes'
    steps:
    - script: |
        git config --global credential.helper '!f() { echo "username=$GITHUB_USERNAME"; echo "password=$GITHUB_TOKEN" }'
        git fetch origin main --unshallow || git fetch origin main
        
        MODIFIED_FILES=()
        while IFS= read -r line; do
          MODIFIED_FILES+=("$line")
        done < <(git diff --name-only origin/main...HEAD)

        ansible_files=()
        keys_files=()
        terraform_files=()

        for i in "${MODIFIED_FILES[@]}"; do

          [[ -e "$i" ]] || continue
          [[ "$i" == .* || "$i" == */.* ]] && continue

          IFS='/' read -r project resource item <<< "$i"

          echo "##vso[task.setvariable variable=PROJECT; isOutput=true]$project"

          case "$resource" in
              ansible)
                ansible_files+=("$item")
                ;;
              keys)
                keys_files+=("$item")
                ;;
              terraform)
                terraform_files+=("$item")
                ;;
            esac

        done

        ansible_files="${ansible_files%,}"
        keys_files="${keys_files%,}"
        terraform_files="${terraform_files%,}"

        echo "##vso[task.setvariable variable=KEYS; isOutput=true]$keys_files"
        echo "##vso[task.setvariable variable=ANSIBLE; isOutput=true]$ansible_files"
        echo "##vso[task.setvariable variable=TERRAFORM;isOutput=true ]$terraform_files"
      name: set_variable
      displayName: 'Get modified roots'
      env:
        GITHUB_USERNAME: $(GITHUB_USERNAME)
        GITHUB_TOKEN: $(GITHUB_TOKEN)

- stage:
  displayName: Teste
  dependsOn: changes
  jobs:
  - job: test
    variables:
      PROJECTS: $[stageDependencies.changes.changeJob.outputs['set_variable.PROJECT']]
      KEYS: $[stageDependencies.changes.changeJob.outputs['set_variable.KEYS']]
      ANSIBLE: $[stageDependencies.changes.changeJob.outputs['set_variable.ANSIBLE']]
      TERRAFORM: $[stageDependencies.changes.changeJob.outputs['set_variable.TERRAFORM']]
    steps:
      - script:
          echo $PROJECT

          echo $KEYS

          echo $ANSIBLE

          echo $TERRAFORM


# - stage: projects
#   displayName: 'Project'
#   dependsOn: changes
#   jobs:
#   - job: projectJob
#     displayName: 'Validating job'
#     variables:
#       PROJECT: $[stageDependencies.changes.changeJob.outputs['set_variable.MODIFIED_ROOTS']]
#     steps:
#     - script: |
#         PROJECT_ID=$(curl "$SEMAPHORE_URL/projects" \
#                       -H "Authorization: Bearer $SEMAPHORE_TOKEN" | jq -r ".[] | select(.name==\"PROJECT\") | .id")
#         if [[ -z $PROJECT ]]; then

#           PROJECT_ID=$(curl -s -XPOST "$SEMAPHORE_URL/projects" \
#                       -H "Authorization: Bearer $SEMAPHORE_TOKEN" \
#                       -H "Content-Type: application/json" \
#                       -d "{ \
#                         \"name\": \"$PROJECT\", \
#                         \"alert\": false \                      
#                       }" | jq -r '.id')
        
#         echo "##vso[task.setvariable variable="PROJECT_ID/ isOutput=true]$PROJECT_ID]"
#       name: set_variable
#       displayName: 'Get project id'
#       env:
#         PROJECT_ID: $(PROJECT_ID)
#         SEMAPHORE_URL: $(SEMAPHORE_URL)
#         SEMAPHORE_TOKEN: $(SEMAPHORE_TOKEN)


# - stage: keys
#   displayName: 'Validating keys'
#   dependsOn: projects
#   jobs:
#   - job: keysJob
#     displayName: 'Keys job'
#     variables:
#       PROJECT_ID: $[stageDependencies.projects.projectJob.outputs['set_variable.PROJECT_ID']]
#     steps:
#     - task: DownloadSecureFile@1
#       displayName: 'Get default repositorykey'
#       inputs:
#         secureFile: 'RepositoryKey'

#     - script: |
#         KEYS_ID=$(curl "$SEMAPHORE_URL/projects" \
#                       -H "Authorization: Bearer $SEMAPHORE_TOKEN" | jq -r ".[] | select(.name==\"PROJECT\") | .id")
#         if [[ -z $PROJECT ]]; then

#           PROJECT_ID=$(curl -s -XPOST "$SEMAPHORE_URL/projects" \
#                       -H "Authorization: Bearer $SEMAPHORE_TOKEN" \
#                       -H "Content-Type: application/json" \
#                       -d "{ \
#                         \"name\": \"$PROJECT\", \
#                         \"alert\": false \                      
#                       }" | jq -r '.id')
        
#         echo "##vso[task.setvariable variable="PROJECT_ID/ isOutput=true]$PROJECT_ID]"

# - stage: iventory

# - stage: repository